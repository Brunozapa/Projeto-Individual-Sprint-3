YUI.add("photostream-route",function(e){function t(e){t.superclass.constructor.call(this,e)}var o=require("hermes-core/type-validator"),i="pu";e.Routes[this.name]=t,e.extend(t,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t){var r,s,a,l=this,n=t.params.nsid_or_path_alias,p=!!t.headers&&t.headers["user-agent"],d=t.params&&t.params.photo_id,u=d?100:25,m=this.getPageNumber(t),h={},c=[],g=this.appContext.getViewer(),f=t.geo;p&&null!==p.match(/^Twitterbot/i)?this.isTwitterbot=!0:this.isTwitterbot=!1,this.isEdit=t.params&&t.params.edit,this.isCameraroll=t.query&&void 0!==t.query.cameraroll,s=this.isEdit?"/photos/"+n+"/edit/":"/photos/"+n+"/";var P=t.query&&""===t.query.helloPro||!1,w=t.query&&void 0!==t.query.giftPro;return r={page:100/u*(m-1)+1,perPage:u,withPhotoId:d},r.orderBy="use_pref",r.viewAs=l.isCameraroll?"me":"use_pref",r.createCompoundID=!d,o.nsid(n)?h.id=n:h.pathAlias=n,(g.signedIn||t.probableUser)&&(c.push(this.appContext.getModel("person-preferences-models",g.signedIn?g.nsid:t.probableUser)),c.push(this.appContext.getModel("person-contacts-count-models",h))),e.Promise.all(c).catch(function(e){if(e.getModelFailure&&t.probableUser)return t.probableUser=null,[];throw e}).then(function(p){var u,c,g,v=!!p[0]&&p[0],x=0,b={};return o.nsid(n)&&v&&(i=v.getValue("photostreamViewAsPref"),c=l.buildContextSuffix(v,n),h.id=n+"-"+c),l.appContext.getModel("photostream-models",h,r).then(function(p){if(g=p.getValue("owner").getValue("nsid"),YUI.Env.isServer&&(x=Math.ceil(p.getValue("totalItems")/100),m>x&&r.page>1&&!isNaN(parseInt(t.params.page_number,10))))return e.Promise.resolve({redirect:s.replace(/page[0-9]+/,"")});if(o.nsid(n)||(v?(i=v.getValue("photostreamViewAsPref"),c=l.buildContextSuffix(v,g),h.id=g+"-"+c):h.id=g),b.withPhotoId=d,b.contextSuffix=c,b.baseURL=s,b.isHelloPro=P,p.getValue("owner").getValue("isPro")&&(w=!1),b.openGiftPro=w,d){if(u=p.getValue("photoPageList"),-1===(a=u.getPageOf({id:d},50))||u.getNextIncompletePage(r)===a)return r.forceAPICall=!0,o.nsid(n)?r.id=n:r.pathAlias=n,u.getPage(r).then(function(e){return m=Math.ceil(50*u.getPageOf({id:d},50)/100),a=m,l.onRouteResolved(p,m,a,b,f)},function(t){return e.Promise.resolve({redirect:s})});m=Math.ceil(50*u.getPageOf({id:d},50)/100),a=m}else a=2*(m-1)+1;return l.onRouteResolved(p,m,a,b,f)},function(o){return o&&d?e.Promise.resolve({redirect:s}):o.timeout?l.appContext.getModel("person-models",h).then(function(t){var o=t.getValue("displayname"),r={view:"empty-page-view",layout:"scrolling",title:o,params:{geo:f,isSlow:!0,viewAs:l.isCameraroll?"me":i,page:"photostream",displayName:o,nsid:t.getValue("nsid"),isCamerarollPhotostream:l.isCameraroll}};return e.Promise.resolve(r)},function(){return l.onRouteRejected(o,t)}):l.onRouteRejected(o,t,s)})}).catch(function(e){return l.onRouteRejected(e,t,s)})},buildContextSuffix:function(t,o){return e.Models["person-preferences-models"].buildContextSuffix(t,o)},onRouteResolved:function(t,o,r,s,a){var l,n=t.getValue("totalItems"),p=t.getValue("owner").getValue("displayname"),d=t.getValue("owner").getValue("nsid"),u=this.appContext.getViewer(),m=!1;if(0===parseInt(n,10))l={view:"empty-page-view",layout:"scrolling",title:p,params:{geo:a,isHelloPro:s.isHelloPro,openGiftPro:s.openGiftPro,displayName:p,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,viewAs:this.isCameraroll?"me":i,page:"photostream",isCamerarollPhotostream:this.isCameraroll}};else{if(m=u.signedIn&&u.nsid===d,this.appContext.flipper.isFlipped("enable-photostream-edit")&&this.isEdit&&!m)return e.Promise.resolve({redirect:s.baseURL.replace(/\/edit/,"")});l={view:this.appContext.flipper.isFlipped("enable-photostream-edit")&&this.isEdit?"photostream-edit-page-view":"photostream-page-view",layout:"scrolling",title:p,params:{geo:a,isHelloPro:s.isHelloPro,openGiftPro:s.openGiftPro,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,withPhotoId:s.withPhotoId,isTwitterbot:this.isTwitterbot,contextId:d+"-"+s.contextSuffix,pageParams:{page:r,perPage:s.withPhotoId?100:50,viewPageSize:100,nominalPage:o,idAttribute:"contextId",createCompoundID:!s.withPhotoId},baseURL:s.baseURL,contextSuffix:s.contextSuffix,isCameraroll:this.isCameraroll}}}return e.Promise.resolve(l)},onRouteRejected:function(t,o,i){if(t.fatal)throw t;return 15===t.code?e.Promise.resolve({redirect:i}):5===t.code?this.displayRouteErrors(o,new e.RouteError(410,this.intlMessage({intlName:"common.404_PHOTOSTREAM_DELETED"}))):this.displayRouteErrors(o,new e.RouteError(404,this.intlMessage({intlName:"common.404_PHOTOSTREAM_NONEXISTENT"})))}}),e.mix(t.prototype,e.Localizable)},"@VERSION@",{requires:["flickr-route","flickr-promise","photostream-models","person-preferences-models"],langBundles:["common"]});