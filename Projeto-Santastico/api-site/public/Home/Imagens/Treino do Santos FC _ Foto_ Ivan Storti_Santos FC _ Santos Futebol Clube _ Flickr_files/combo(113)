YUI.add("hermes-template-testimonial-write",function(e,n){var l=e.Template.Handlebars.revive({1:function(e,n,l,t,a){var r,i=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return'data-testimonial-id="'+e.escapeExpression(e.lambda(null!=(r=null!=n?i(n,"testimonial"):n)?i(r,"id"):r,n))+'"'},3:function(e,n,l,t,a){var r,i=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return null!=(r=e.invokePartial(i(t,"pro-badge"),n,{name:"pro-badge",hash:{badgeType:null!=(r=null!=n?i(n,"viewerModel"):n)?i(r,"proBadge"):r},data:a,indent:"\t\t\t",helpers:l,partials:t,decorators:e.decorators}))?r:""},5:function(e,n,l,t,a){var r,i=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return e.escapeExpression(e.lambda(null!=(r=null!=n?i(n,"testimonial"):n)?i(r,"body"):r,n))},compiler:[8,">= 4.3.0"],main:function(e,n,l,t,a){var r,i=null!=n?n:e.nullContext||{},o=e.lambda,s=e.escapeExpression,u=e.hooks.helperMissing,c=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return'<div class="write-testimonial" '+(null!=(r=c(l,"if").call(i,null!=n?c(n,"testimonial"):n,{name:"if",hash:{},fn:e.program(1,a,0),inverse:e.noop,data:a,loc:{start:{line:1,column:31},end:{line:1,column:97}}}))?r:"")+'>\n\t<div class="user-infos">\n\t\t<a class="avatar person small" data-person-nsid="'+s(o(null!=(r=null!=n?c(n,"viewerModel"):n)?c(r,"nsid"):r,n))+'" href="'+s(o(null!=(r=null!=n?c(n,"viewerModel"):n)?c(r,"url"):r,n))+'" style="background-image: url('+s(o(null!=(r=null!=(r=null!=n?c(n,"viewerModel"):n)?c(r,"buddyicon"):r)?c(r,"default"):r,n))+')">\n\t\t</a>\n\n\t\t<a href="'+s(o(null!=(r=null!=n?c(n,"viewerModel"):n)?c(r,"url"):r,n))+'" class="username" data-track="testimonialUserNameClick" data-action="follow">'+s(o(null!=(r=null!=n?c(n,"viewerModel"):n)?c(r,"displayname"):r,n))+"</a>\n\n"+(null!=(r=c(l,"if").call(i,null!=(r=null!=n?c(n,"viewerModel"):n)?c(r,"isPro"):r,{name:"if",hash:{},fn:e.program(3,a,0),inverse:e.noop,data:a,loc:{start:{line:8,column:2},end:{line:10,column:9}}}))?r:"")+'\t</div>\n\t<div class="body">\n\t\t<textarea class="testimonial-content resizable-vert">'+(null!=(r=c(l,"if").call(i,null!=n?c(n,"testimonial"):n,{name:"if",hash:{},fn:e.program(5,a,0),inverse:e.noop,data:a,loc:{start:{line:13,column:55},end:{line:13,column:101}}}))?r:"")+'</textarea>\n\t</div>\n\n\t<div class="action-container">\n\t\t<div class="label">\n\t\t\t '+s((c(l,"intlMessage")||n&&c(n,"intlMessage")||u).call(i,{name:"intlMessage",hash:{username:null!=(r=null!=n?c(n,"person"):n)?c(r,"displayname"):r,intlName:"profile.TESTIM_SENT_APPROVAL"},data:a,loc:{start:{line:18,column:4},end:{line:18,column:87}}}))+'\n\t\t</div>\n\n\t\t<div class="actions">\n\t\t\t<button type="button" class="butt cancel alt">'+s((c(l,"intlMessage")||n&&c(n,"intlMessage")||u).call(i,{name:"intlMessage",hash:{intlName:"common.CANCEL"},data:a,loc:{start:{line:22,column:49},end:{line:22,column:89}}}))+'</button>\n\t\t\t<button type="button" class="butt post">'+s((c(l,"intlMessage")||n&&c(n,"intlMessage")||u).call(i,{name:"intlMessage",hash:{intlName:"profile.TESTIM_POST"},data:a,loc:{start:{line:23,column:43},end:{line:23,column:89}}}))+"</button>\n\t\t</div>\n\t</div>\n</div>\n"},usePartial:!0,useData:!0}),t={};e.Array.each(["pro-badge"],function(n){var l=e.Template.get("hermes/"+n);l&&(t[n]=l)}),e.Template.register("hermes/testimonial-write",function(n,a){return a=a||{},a.partials=a.partials?e.merge(t,a.partials):t,l(n,a)})},"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-pro-badge"]});YUI.add("profile-testimonials-view",function(t,e){t.namespace("Views")[this.name]=t.Base.create("profile-testimonials-view",t.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){this.nsid=t.nsid,this.pathAlias=t.pathAlias,this.isViewingSelf=t.isViewingSelf,this.showcaseSetId=t.showcaseSetId,this.isEditingTestimonial=t.isEditingTestimonial,this.set("currentPage",1);var e=this.isViewingSelf?"all":"about";return this.sort="all",this.apiParams={type:e,perPage:this.isEditingTestimonial?500:30,page:1,nsid:this.nsid,id:e+"-"+this.nsid},this},loadState:function(){return this.appContext.getModelRegistry("testimonials-models").then(function(e){e.removeAll();var i=[this.appContext.getModel("person-models",this.nsid),this.appContext.getModel("testimonials-models",this.apiParams)];if(this.appContext.getViewer().signedIn&&(i.push(this.appContext.getModel("person-models",this.appContext.getViewer().nsid)),!this.isViewingSelf)){var s=t.clone(this.apiParams),n=t.clone(this.apiParams);s.type="pendingByAbout",s.id=s.type+"-"+this.nsid,i.push(this.appContext.getModel("testimonials-models",s)),i.push(this.appContext.getModel("person-relationship-models",this.nsid)),n.type="aboutBy",n.id=n.type+"-"+this.nsid,i.push(this.appContext.getModel("testimonials-models",n))}return t.Promise.all(i).then(function(t){if(this.set("personModel",t[0]),this.set("testimonialsModel",t[1]),this.set("firstPageTestimonial",t[1].getValue("testimonialsList")),t[2]&&this.set("viewerModel",t[2]),t[3]){this.set("pendingTestimonialModels",t[3]);var e=t[3].getValue("testimonialsList").getFirstItem();e&&e.item&&this.set("pendingTestimonialModel",e.item)}t[4]&&this.set("isIgnoredBy",t[4].getValue("isIgnoredBy")),t[5]&&t[5].getValue("testimonialsList").size()&&this.set("hasWrittenTestimonials",!0)}.bind(this))}.bind(this))},buildContainer:function(){var t=this.get("firstPageTestimonial").toJSON(),e=!this.isViewingSelf,i=!1;return t.forEach(function(t,i){(t=this.parseTestimonial(t)).isByViewingUser&&(e=!1)}.bind(this)),(this.get("pendingTestimonialModel")||0===this.get("firstPageTestimonial").size()||this.get("isIgnoredBy")||this.get("hasWrittenTestimonials"))&&(e=!1),i=0===this.get("firstPageTestimonial").size()&&!this.get("pendingTestimonialModel"),this.setContainerWithTemplate("profile-testimonials",{isViewingSelf:this.isViewingSelf,isIgnoredBy:this.get("isIgnoredBy"),isViewingGivenTestimonials:this.isViewingGivenTestimonials(),viewerModel:!!this.appContext.getViewer().signedIn&&this.get("viewerModel").toJSON(),person:this.get("personModel").toJSON(),noTestimonials:i,testimonials:t,showHeaderWriteTestimonial:e,pendingTestimonialModel:!!this.get("pendingTestimonialModel")&&this.parseTestimonial(this.get("pendingTestimonialModel").toJSON()),showLoadMore:30===this.get("firstPageTestimonial").size()}),this},isViewingGivenTestimonials:function(){return"allBy"===this.sort},parseTestimonial:function(t){return t.body.length>320&&(t.shortBody=t.body.slice(0,320)),t},loadTestimonials:function(){return this.get("testimonialsModel").getValue("testimonialsList").getPage(this.apiParams)},activate:function(){var e=this.get("container");return this.registerEventHandler(e.delegate("click",this.loadMoreTestimonials.bind(this),".load-more")),this.registerEventHandler(e.delegate("click",this.onApproveTestimonial.bind(this),"button.approve")),this.registerEventHandler(e.delegate("click",this.onRejectTestimonial.bind(this),"button.reject")),this.registerEventHandler(e.delegate("click",this.onReadMoreTestimonial.bind(this),".read-more-testimonial")),this.registerEventHandler(e.delegate("click",this.onReadLessTestimonial.bind(this),".read-less-testimonial")),this.registerEventHandler(e.delegate("click",this.onWriteTestimonialClick.bind(this),".show-write-testim")),this.appContext.getViewer().signedIn&&(this.registerEventHandler(e.delegate("click",this.onCancelWriteTestimonialClick.bind(this),".write-testimonial .cancel")),this.registerEventHandler(e.delegate("click",this.onPostTestimonialClick.bind(this),".write-testimonial .post")),this.registerEventHandler(e.delegate("click",this.onEditTestimonialClick.bind(this),".edit")),this.registerEventHandler(e.delegate("click",this.onDeleteTestimonialClick.bind(this),".delete")),this.registerEventHandler(e.delegate("click",this.onDeleteTestimonialClick.bind(this),".delete-approved-testim")),this.registerEventHandler(e.delegate("click",this.onEditTestimonialClick.bind(this),".edit-approved-testim")),this.isEditingTestimonial&&this.triggerEditTestimonial()),this.isViewingSelf&&(this.registerEventHandler(e.delegate("click",this.onGivenDropdownClick.bind(this),".given-about")),t.Accessibility.makeDroparoundAnchorAccessible({view:this,getDroparound:this.getDroparound.bind(this),anchor:e.one(".given-about"),handler:this.onGivenDropdownClick.bind(this)})),this},getDroparound:function(){return this.dropdown},triggerEditTestimonial:function(){var e=t.config.win.location.hash;if(e){var i=this.get("container").one(e).one(".edit-testim");i&&i.getDOMNode().click()}},loadMoreTestimonials:function(t){this.set("currentPage",this.get("currentPage")+1),this.apiParams.page=this.get("currentPage"),this.isLoadingNewTestimonials||(this.isLoadingNewTestimonials=!0,this.loadTestimonials().then(function(t){this.appendNewTestimonials(t)}.bind(this)))},appendNewTestimonials:function(e){var i="",s=this.get("container"),n=s.one(".load-more"),o=s.one(".testimonials-list");e?(e.length<30&&n.remove(),t.Array.map(e,function(t,e){i+=this.templates("testimonial-container")(this.parseTestimonial(t.toJSON()))}.bind(this)),o.append(i),this.isLoadingNewTestimonials=!1):n.remove()},onApproveTestimonial:function(t){var e=t.target.getData("testimonial-id"),i=this.get("testimonialsModel").getValue("testimonialsList").getFromListByID(e);i&&i.registry.remote.approve({id:e},this.appContext).then(function(t){this.rebuildTestimonial(i)}.bind(this)).catch(function(t){this.somethingWentWrong(!!t&&t.message)}.bind(this))},onRejectTestimonial:function(e){var i=e.target.getData("testimonial-id"),s=this.get("testimonialsModel").getValue("testimonialsList").getFromListByID(i),n=new t.Views.FluidModal({title:this.intlMessage({intlName:"profile.TESTIM_DELETE_CONFIRM"}),actionButtonLabel:this.intlMessage({intlName:"common.DELETE"}),textMessage:this.intlMessage({intlName:"profile.TESTIM_DELETE_TEXT"}),appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,actionButtonDisabled:!1,actionButtonIsDangerous:!0,showCancelButton:!0,hideModalOverlay:!1,showCancelX:!0});n.on("actionClick",function(){s&&s.registry.remote.reject({id:i},this.appContext).then(function(t){t.stat&&"ok"===t.stat&&this.deleteTestimonial(t.id)}.bind(this)).catch(function(t){this.somethingWentWrong(!!t&&t.message)}.bind(this))}.bind(this)),n.show()},rebuildTestimonial:function(t){var e=this.get("container").one('.testimonial[data-testimonial-id="'+t.getValue("id")+'"]');e&&(e.setHTML(this.templates("testimonial")(this.parseTestimonial(t.toJSON()))),e.toggleClass("pending",!t.getValue("approved")))},deleteTestimonial:function(t){var e=this.get("container").one('.testimonial[data-testimonial-id="'+t+'"]');e&&e.remove()},onWriteTestimonialClick:function(e){e.stopPropagation(),e.preventDefault();var i=this.get("container"),s=i.one(".testimonials-list"),n=i.one(".write-testimonial-placeholder");if(!this.appContext.getViewer().signedIn)return t.SigninHelper._redirectToSignin("",{postLoginUrl:t.config.win.location.href});n&&(0===this.get("firstPageTestimonial").size()&&s.empty(),n.setHTML(this.templates("testimonial-write")({viewerModel:this.get("viewerModel").toJSON(),person:this.get("personModel").toJSON()})),n.one("textarea").focus())},onEditTestimonialClick:function(e){e.stopPropagation(),e.preventDefault();var i=e.target.ancestor(".testimonial",!0);if(i){var s=i.getData("testimonial-id");return this.appContext.getModel("testimonial-models",{id:s}).then(function(e){if(s&&e)if(this.isViewingGivenTestimonials()){var n,o,a=t.URLHelper.generatePersonUrls(e.getValue("aboutUser")),l=e.getValue("aboutUser").getValue("displayname");o=this.intlMessage({intlName:"profile.TESTIM_EDIT_VISIT_PROFILE",username:l})+" "+this.intlMessage({intlName:"profile.TESTIM_EDIT_VISIT_PROFILE_TEXT",username:l}),(n=new t.Views.FluidModal({title:this.intlMessage({intlName:"profile.TESTIM_EDIT_CONFIRM_TITLE"}),actionButtonLabel:this.intlMessage({intlName:"profile.TESTIM_EDIT_VISIT_PROFILE_GO"}),textMessage:o,appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,actionButtonDisabled:!1,showCancelButton:!0,hideModalOverlay:!1,showCancelX:!0})).on("actionClick",function(){t.config.win.location=a.profile+"?edit#testimonial"+e.getValue("id")}.bind(this)),n.show()}else if(this.isEditingTestimonial)this.replaceContainerWithEditForm(e,i);else{var r=new t.Views.FluidModal({title:this.intlMessage({intlName:"profile.TESTIM_EDIT_CONFIRM_TITLE"}),actionButtonLabel:this.intlMessage({intlName:"common.OK"}),textMessage:this.intlMessage({intlName:"profile.TESTIM_EDIT_CONFIRM_TEXT"}),appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,actionButtonDisabled:!1,showCancelButton:!0,hideModalOverlay:!1,showCancelX:!0});r.on("actionClick",function(){this.replaceContainerWithEditForm(e,i)}.bind(this)),r.show()}}.bind(this))}},replaceContainerWithEditForm:function(t,e){var i=this.parseTestimonial(t.toJSON());i.byUser=this.get("viewerModel").toJSON(),e.setHTML(this.templates("testimonial-write")({testimonial:i,viewerModel:this.get("viewerModel").toJSON(),person:this.get("personModel").toJSON()})),e.one("textarea").focus()},onCancelWriteTestimonialClick:function(t){t.stopPropagation(),t.preventDefault(),this.buildContainer()},onPostTestimonialClick:function(e){e.stopPropagation(),e.preventDefault();var i=this.get("container"),s=(this.get("testimonialsModel"),i.one(".write-testimonial")),n=s.getAttribute("data-testimonial-id"),o=s.one(".testimonial-content").get("value");if(o)return this.appContext.getModelRegistry("testimonial-models").then(function(e){if(n){var i=this.get("personModel").getValue("id");e.get(n).then(function(s){s.getValue("aboutUser")&&(i=s.getValue("aboutUser").id),e.remote.update({userId:i,id:n,text:o},this.appContext).then(function(){new t.Views.FluidModal({title:this.intlMessage({intlName:"profile.TESTIM_GREAT_TITLE"}),actionButtonLabel:this.intlMessage({intlName:"common.OK"}),textMessage:this.intlMessage({intlName:"profile.TESTIM_SENT_APPROVAL_SHOWN",username:this.get("personModel").getValue("displayname")}),appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,actionButtonDisabled:!1,showCancelButton:!1,hideModalOverlay:!1,showCancelX:!0}).show(),this.buildContainer()}.bind(this)).catch(function(t){this.somethingWentWrong(!!t&&t.message)}.bind(this))}.bind(this))}else e.remote.create({id:this.get("personModel").getValue("id"),text:o},this.appContext).then(function(t){t?this.appendPendingTestimonial(t):this.buildContainer()}.bind(this)).catch(function(t){this.somethingWentWrong(!!t&&t.message)}.bind(this))}.bind(this))},appendPendingTestimonial:function(e){this.get("pendingTestimonialModels")&&e&&(this.get("pendingTestimonialModels").getValue("testimonialsList").push(e),this.loadState().then(function(){this.buildContainer();new t.Views.FluidModal({title:this.intlMessage({intlName:"profile.TESTIM_GREAT_TITLE"}),actionButtonLabel:this.intlMessage({intlName:"common.OK"}),textMessage:this.intlMessage({intlName:"profile.TESTIM_SENT_APPROVAL_SHOWN",username:this.get("personModel").getValue("displayname")}),appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,actionButtonDisabled:!1,showCancelButton:!1,hideModalOverlay:!1,showCancelX:!0}).show()}.bind(this)))},onDeleteTestimonialClick:function(e){var i;this.get("testimonialsModel");e.target&&(i=e.target.ancestor(".testimonial",!0).getAttribute("data-testimonial-id"));var s=new t.Views.FluidModal({title:this.intlMessage({intlName:"profile.TESTIM_DELETE_CONFIRM"}),actionButtonLabel:this.intlMessage({intlName:"common.DELETE"}),textMessage:this.intlMessage({intlName:"profile.TESTIM_DELETE_TEXT"}),appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,actionButtonDisabled:!1,actionButtonIsDangerous:!0,showCancelButton:!0,hideModalOverlay:!1,showCancelX:!0});s.on("actionClick",function(){return this.appContext.getModelRegistry("testimonial-models").then(function(e){e.remote.reject({id:i},this.appContext).then(function(e){new t.Views.FluidModal({appContext:this.appContext,message:this.intlMessage({intlName:"common.ALMOST_DONE"}),showButtons:!1}).show(),t.config.win.location.reload()}.bind(this)).catch(function(t){this.somethingWentWrong(!!t&&t.message)}.bind(this))}.bind(this))}.bind(this)),s.show()},somethingWentWrong:function(e){var i=new t.Views.FluidModal({title:this.intlMessage({intlName:"common.OOPS"}),actionButtonLabel:this.intlMessage({intlName:"common.REFRESH"}),textMessage:e||this.intlMessage({intlName:"profile.SHOWCASE_ERR"}),appContext:this.appContext,dismissOnOverlayClick:!1,dismissOnActionClick:!0,actionButtonDisabled:!1,actionButtonIsDangerous:!0,showCancelButton:!1,hideModalOverlay:!1,showCancelX:!0});i.on("actionClick",function(){new t.Views.FluidModal({appContext:this.appContext,message:this.intlMessage({intlName:"common.ALMOST_DONE"}),showButtons:!1}).show(),t.config.win.location.reload()}.bind(this)),i.show()},onGivenDropdownClick:function(e){e.halt();var i=e.target.ancestor(".dropdown-link",!0),s=i.one(".dropdown-arrow");this.dropdown=new t.Views.FluidDroparound({appContext:this.appContext,showDropArrow:!0,observePageResize:!0,anchorElement:this.appContext.flipper.isFlipped("enable-droparound-enhance-2021")?s:i,keyboardAnchorElement:this.appContext.flipper.isFlipped("enable-droparound-enhance-2021")?s:i,minVerticalSpace:400,positionFixed:!0,preferLeft:!0,closeOnScroll:!0,anchorOffsetHorizontal:16,menuItems:[{text:this.intlMessage({intlName:"profile.TESTIM_FILTER_RECEIVED"}),key:"all",isSelected:"all"===this.sort},{text:this.intlMessage({intlName:"profile.TESTIM_FILTER_GIVEN"}),key:"allBy",isSelected:"allBy"===this.sort}]}),this.dropdown.show(),this.registerEventHandler(this.dropdown.on("selected",function(e){if(e&&e.menuItem){var i=e.menuItem.key;e.menuItem.text;this.sort=i,t.loaderBar.start(),this.apiParams.type=this.sort,this.apiParams.id=this.apiParams.type+"-"+this.nsid,this.loadState().then(function(){t.loaderBar.progress(),this.buildContainer(),t.loaderBar.finish(),t.use("anim",function(t){new t.Anim({duration:.5,node:"win",easing:"easeBoth",to:{scroll:[0,this.get("container").getDOMNode().offsetTop-100]}}).run()}.bind(this))}.bind(this))}this.dropdown.close()}.bind(this)),this)},onReadMoreTestimonial:function(t){if(t.halt(),t){var e=t.target.ancestor(".body",!0);e&&e.removeClass("shortened")}},onReadLessTestimonial:function(t){if(t.halt(),t){var e=t.target.ancestor(".body",!0);e&&e.addClass("shortened")}}})},"@VERSION@",{requires:["flutil","flickr-view","flickr-promise","testimonials-models","hermes-template-profile-testimonials","hermes-template-testimonial","hermes-template-testimonial-container","hermes-template-testimonial-write","url-helper"],langBundles:["profile","common"]});